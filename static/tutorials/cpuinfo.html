<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<head>
	<title>Hazelware</title>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<LINK REL="SHORTCUT ICON" HREF="logo.ico">
</head>



<body vlink='#3173EB' link='#3173EB' leftmargin=0 topmargin=0 marginwidth=0 marginheight=0>

<meta name="ICBM" content="45.30027, -122.9719" />
<meta name="keywords" content="Palm PalmOS WinCE PocketPC PDA Development Wireless" />
<meta name="description" content="Postings from a wireless PDA developer." />
<link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
<style type="text/css">
<!--
A		{text-decoration:none}
a		{text-decoration:none}
A:hover 	{ color: #000000;  }
a:hover 	{ color: #000000;  }
-->
</style>


<table border=0 valign=top width=780>
	<TR>
		<TD width=100 valign=top>
		</TD>

		<!-- Title graphic -->
		<TD width=620 valign=top>
			<center><IMG SRC="/images/title.jpg" border=0 width=319 height=69></center>
			<br>&nbsp &nbsp &nbsp 


				<b><small>Logged in as <I><A HREF='/login.html'>Guest</A></I> &nbsp Fri, Mar. 26th, 4:18 AM.  &nbsp &nbsp &nbsp </small></b>
	
		</TD>
		<TD>
		</TD>
	</TR>
	<TR>

		<!-- Spacer for left border -->
		<TD>
		<!-- MyMap -->
		<a href="http://www.maploco.com/view.php?id=2376202"><img border=0 width=150 height=75 src="http://www.maploco.com/vmap/2376202.png" alt="Visitor Map"></a>
		</TD>

		<!-- Image map for browsing -->
		<TD width=620 valign=top>
			<TABLE width="100%" align=center valign=top>
				<TR>
					<TD width="100%">
						<MAP NAME="linkmap">
							<AREA SHAPE="RECT" COORDS= "10,27,90,52"  HREF="/">
							<AREA SHAPE="RECT" COORDS="100,27,207,52" HREF="/programs/">
							<AREA SHAPE="RECT" COORDS="220,27,328,52" HREF="/tutorials/">
							<AREA SHAPE="RECT" COORDS="338,27,428,52" HREF="/friends/">
							<AREA SHAPE="RECT" COORDS="442,27,509,52" HREF="/links/">
							<AREA SHAPE="RECT" COORDS="517,27,608,52" HREF="mailto:bosshogg@luggle.com">
						</MAP>
						<IMG src="/images/header.jpg" width=619 height=79 USEMAP="#linkmap" border=0>
					</TD>
				</TR>
			</TABLE>

		</TD>

		<TD>
		</TD>

		<TD>
		</TD>	
	</TR>
	
	<TR>
		<TD align=right valign=top>

		<TABLE border=0 cellspacing=0 cellpadding=0 width=150 align=center valign=top bordercolor='#000000'>
<TR><TD>
<TABLE border=1 cellspacing=0 cellpadding=5 width=100% align=center valign=top bordercolor='#000000'><TR><TD bgcolor='#B5D0FF'><B>Recent Entries:</B></TD></TR>
<TR><TD bgcolor='#ffffff' height=100%>
<small>
<TABLE valign=top align=left>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-127.html'><small>My Dev Setup Lately</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-126.html'><small>Three Ways To Randomize on the iPhone</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-125.html'><small>How to Remove .svn Directories On a Mac</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-124.html'><small>How To Detect The iPhone Simulator</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-123.html'><small>iPhoneMom Likes Doodle Games!</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-122.html'><small>Updates To the Doodle Games Line</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-120.html'><small>Three Jacks Now Tweets</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-119.html'><small>Second iPhone App Submitted For Approval!</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-118.html'><small>Pinch Media Analytics for iPhone</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-117.html'><small>New iPhone Game Coming Soon!</small></a></TD></TR>
</TABLE>
</TD></TR>
<TR><TD align=center valign=center>
<A HREF='/rss.xml'><IMG SRC='/images/rss.gif' border=0 width=60 height=14></A>
</TD></TR>
</TABLE>
</TD></TR>
<TR><TD><SMALL><SMALL><BR></SMALL></SMALL></TD></TR><TR><TD><TABLE border=1 cellspacing=0 cellpadding=5 width=100% align=center valign=top bordercolor='#000000'><TR><TD bgcolor='#B5D0FF'><B>Archive:</B></TD></TR><TR><TD bgcolor='#ffffff'><A HREF='/archive-2010.1.html'>January - 2010</A><br><A HREF='/archive-2009.11.html'>November - 2009</A><br><A HREF='/archive-2009.10.html'>October - 2009</A><br><A HREF='/archive-2009.9.html'>September - 2009</A><br><A HREF='/archive-2009.8.html'>August - 2009</A><br><A HREF='/archive-2009.7.html'>July - 2009</A><br><A HREF='/archive-2009.6.html'>June - 2009</A><br><A HREF='/archive-2009.4.html'>April - 2009</A><br><A HREF='/archive-2009.3.html'>March - 2009</A><br><A HREF='/archive-2009.1.html'>January - 2009</A><br><A HREF='/archive-2008.5.html'>May - 2008</A><br><A HREF='/archive-2008.4.html'>April - 2008</A><br><A HREF='/archive-2008.3.html'>March - 2008</A><br><A HREF='/archive-2007.10.html'>October - 2007</A><br><A HREF='/archive-2007.8.html'>August - 2007</A><br><A HREF='/archive-2007.7.html'>July - 2007</A><br><A HREF='/archive-2007.6.html'>June - 2007</A><br><A HREF='/archive-2007.5.html'>May - 2007</A><br><A HREF='/archive-2007.4.html'>April - 2007</A><br><A HREF='/archive-2006.12.html'>December - 2006</A><br><A HREF='/archive-2006.11.html'>November - 2006</A><br><A HREF='/archive-2006.9.html'>September - 2006</A><br><A HREF='/archive-2006.8.html'>August - 2006</A><br><A HREF='/archive-2006.7.html'>July - 2006</A><br><A HREF='/archive-2006.3.html'>March - 2006</A><br><A HREF='/archive-2006.2.html'>February - 2006</A><br><A HREF='/archive-2006.1.html'>January - 2006</A><br><A HREF='/archive-2005.12.html'>December - 2005</A><br><A HREF='/archive-2005.11.html'>November - 2005</A><br><A HREF='/archive-2005.10.html'>October - 2005</A><br><A HREF='/archive-2005.9.html'>September - 2005</A><br><A HREF='/archive-2005.8.html'>August - 2005</A><br><A HREF='/archive-2005.7.html'>July - 2005</A><br><A HREF='/archive-2005.6.html'>June - 2005</A><br><A HREF='/archive-2005.5.html'>May - 2005</A><br><A HREF='/archive-2005.4.html'>April - 2005</A><br><A HREF='/archive-2005.2.html'>February - 2005</A><br><A HREF='/archive-2005.1.html'>January - 2005</A><br><A HREF='/archive-2004.12.html'>December - 2004</A><br><A HREF='/archive-2004.11.html'>November - 2004</A><br><A HREF='/archive-2004.10.html'>October - 2004</A><br><A HREF='/archive-2004.9.html'>September - 2004</A><br><A HREF='/archive-2004.8.html'>August - 2004</A><br><A HREF='/archive-2004.7.html'>July - 2004</A><br><A HREF='/archive-2004.6.html'>June - 2004</A><br><A HREF='/archive-2004.5.html'>May - 2004</A><br><A HREF='/archive-2004.4.html'>April - 2004</A><br><A HREF='/archive-2004.3.html'>March - 2004</A><br></TD></TR></TABLE></small>
</TD></TR></TABLE>

		</TD>
		<TD width=620 valign=top>


<TABLE border=1 cellspacing=0 cellpadding=0 bordercolor='#000000'>
<TR><TD>

<TABLE width=600 BGCOLOR='#B5D0FF' height=50 align=center>
<TR><TD align=center>
<BIG><BIG><B>CPU Detection Code</B></BIG></BIG>
</TD></TR>
</TABLE>

</TD></TR><TR><TD>

<TABLE BGCOLOR='#ffffff' cellspacing=10 width=600><TR><TD width=100%>
I dug this code up from a project that I worked on a long time ago.  Unfortunately, 
it is woefully out of date, especially with any of the latest P4 processors.  
Also unfortunately, I don't have a large suite of machines on which to test this,
however, I have verified a large number of these, but not all.  
Also missing from the list are any AMD processors since my old companies didn't
explicitly support AMD.  Oh, well.  As always, this code is to be used at your own
expense, and I guess with this particular set of code, that means a little more.
Anyway, I hope someone finds this interesting, and if you have any questions,
feel free to <A HREF="mailto:jhays@dsl-only.net">ask</A>.
<BR>
<BR>
<I>-BossHogg</I>
<BR>
<BR>
<BR>
<FONT face="Times New Roman" SIZE=2>
<BR>#include "windows.h"
<BR>
<BR>
<BR>bool				QueryCPUID();
<BR>bool				QueryMMX();
<BR>bool				QueryHyperThreading();
<BR>void				QueryVendorString(char* string);
<BR>bool				QuerySerialNumber(char* string);
<BR>void				GetCPUInfoString(char* string);
<BR>unsigned long		QueryCacheSize();
<BR>unsigned long		QueryCPUCount();
<BR>unsigned char		QueryCPUModel();
<BR>unsigned char		QueryCPUFamily();
<BR>unsigned char		QueryCPUStepping();
<BR>unsigned char		QueryCPUType();
<BR>
<BR>
<BR>bool Is8086()
<BR>{
<BR><DD>	int is8086=0;
<BR>
<BR><DD>	__asm {
<BR>	
<BR><DD><DD><DD>		pushf
<BR><DD><DD><DD>		pop ax
<BR><DD><DD><DD>		mov cx, ax
<BR><DD><DD><DD>		and ax, 0fffh
<BR><DD><DD><DD>		push ax
<BR><DD><DD><DD>		popf
<BR><DD><DD><DD>		pushf
<BR><DD><DD><DD>		pop ax
<BR><DD><DD><DD>		and ax, 0f000h
<BR><DD><DD><DD>		cmp ax, 0f000h
<BR><DD><DD><DD>		mov is8086, 0
<BR><DD><DD><DD>		jne DONE_8086_CHECK
<BR><DD><DD><DD>		mov is8086, 1
<BR>
<BR><DD>DONE_8086_CHECK:
<BR><DD>	};
<BR>
<BR><DD>	return !!is8086;
<BR>}
<BR>
<BR>bool Is80286()
<BR>{
<BR><DD>	int is80286=0;
<BR><DD>	__asm {
<BR><DD><DD><DD>		smsw ax
<BR><DD><DD><DD>		and ax, 1
<BR><DD><DD><DD>		or cx, 0f000h
<BR><DD><DD><DD>		push cx
<BR><DD><DD><DD>		popf
<BR><DD><DD><DD>		pushf
<BR><DD><DD><DD>		pop ax
<BR><DD><DD><DD>		and ax, 0f000h
<BR><DD><DD><DD>		mov is80286, 1
<BR><DD><DD><DD>		jz DONE_80286_CHECK
<BR><DD><DD><DD>		mov is80286, 0
<BR>
<BR><DD>	DONE_80286_CHECK:
<BR><DD>	};
<BR>
<BR><DD>	return !!is80286;
<BR>}
<BR>
<BR>
<BR>bool Is80386()
<BR>{
<BR><DD>	int is80386=0;
<BR><DD>	__asm {
<BR><DD><DD><DD>		pushfd
<BR><DD><DD><DD>		pop eax
<BR><DD><DD><DD>		mov ecx, eax
<BR><DD><DD><DD>		xor eax, 40000h
<BR><DD><DD><DD>		push eax
<BR><DD><DD><DD>		popfd
<BR><DD><DD><DD>		pushfd
<BR><DD><DD><DD>		pop eax
<BR><DD><DD><DD>		xor eax, ecx
<BR><DD><DD><DD>		mov is80386, 1
<BR><DD><DD><DD>		jz DONE_80386_CHECK
<BR><DD><DD><DD>		mov is80386, 0
<BR>
<BR><DD>	DONE_80386_CHECK:
<BR><DD>	};
<BR>
<BR><DD>	return !!is80386;
<BR>}
<BR>
<BR>bool QueryCPUID()
<BR>{
<BR><DD>	int hasCPUID=0;
<BR>
<BR><DD>	__asm
<BR><DD>	{
<BR><DD><DD><DD>		pushfd						
<BR><DD><DD><DD>		pop			eax
<BR><DD><DD><DD>		mov			ecx, eax
<BR><DD><DD><DD>		and         ecx, 0x00200000
<BR><DD><DD><DD>		xor			eax, 0x00200000
<BR><DD><DD><DD>		push		eax
<BR><DD><DD><DD>		popfd						
<BR><DD><DD><DD>		pushfd						
<BR><DD><DD><DD>		pop			eax
<BR><DD><DD><DD>		and			eax, 0x00200000
<BR><DD><DD><DD>		xor			eax, ecx		
<BR><DD><DD><DD>		mov			hasCPUID, eax
<BR><DD>	};
<BR>
<BR><DD>	return !!hasCPUID;
<BR>}
<BR>
<BR>bool QueryMMX()
<BR>{	
<BR><DD>	bool canDoMMX=false;
<BR><DD>	__asm
<BR><DD>    {
<BR><DD><DD><DD>		mov     eax, 1           ; request for feature flags
<BR><DD><DD><DD>	   	_emit	0x0F             ; CPUID on Pentiums is 0f,a2
<BR><DD><DD><DD>	    _emit	0xA2
<BR><DD><DD><DD>	    test    edx, 0x00800000  ; is MMX technology Bit(bit 23)in feature                               
<BR><DD><DD><DD>        jz      DONE_MMX_CHECK	 ; flags equal to 1
<BR><DD><DD><DD>        mov     canDoMMX,1
<BR><DD>    DONE_MMX_CHECK:
<BR><DD>    };
<BR>	
<BR><DD>    return canDoMMX;
<BR>}
<BR>
<BR>bool QueryHyperThreading()
<BR>{
<BR><DD>	unsigned int regEdx      = 0;
<BR><DD>	unsigned int regEax      = 0;
<BR><DD>	unsigned int vendorId[3] = {0, 0, 0};
<BR>
<BR><DD>	if (!QueryCPUID())
<BR><DD><DD><DD>		return false;
<BR>
<BR><DD>	__asm
<BR><DD>	{
<BR><DD><DD><DD>		xor eax, eax          // call cpuid with eax = 0
<BR><DD><DD><DD>       	cpuid                 // Get vendor id string
<BR><DD><DD><DD>		mov vendorId, ebx
<BR><DD><DD><DD>		mov vendorId + 4, edx
<BR><DD><DD><DD>		mov vendorId + 8, ecx
<BR>			
<BR><DD><DD><DD>		mov eax, 1            // call cpuid with eax = 1
<BR><DD><DD><DD>		cpuid
<BR><DD><DD><DD>		mov regEax, eax      // eax contains family processor type
<BR><DD><DD><DD>		mov regEdx, edx      // edx has info about the availability of hyper-Threading
<BR><DD>	}
<BR>
<BR>
<BR><DD>    if (((regEax & 0x0F00) ==  0x0F00) || (regEax & 0x0F00000))
<BR><DD>	{
<BR><DD><DD><DD>		if (vendorId[0] == 'uneG' && vendorId[1] == 'Ieni' && vendorId[2] == 'letn')
<BR><DD><DD><DD>		{
<BR><DD><DD><DD><DD>			return !!(regEdx & 0x10000000);
<BR><DD><DD><DD>		}
<BR><DD>	}
<BR>
<BR><DD>	return false;  
<BR>}
<BR>
<BR>
<BR>void QueryVendorString(char* string)
<BR>{
<BR><DD>	char vendorId[12];
<BR><DD>	__asm{
<BR><DD><DD><DD>		mov     eax, 0           ; request for feature flags
<BR><DD><DD><DD>	   	_emit	0x0F             ; CPUID on Pentiums is 0f,a2
<BR><DD><DD><DD>	    _emit	0xA2
<BR>		
<BR><DD><DD><DD>		mov dword ptr vendorId, ebx
<BR><DD><DD><DD>		mov dword ptr vendorId[+4], edx
<BR><DD><DD><DD>		mov dword ptr vendorId[+8], ecx
<BR><DD>	};
<BR>
<BR><DD>	memcpy(string,vendorId,12);
<BR><DD>	string[12]=0;
<BR>}
<BR>
<BR>unsigned char QueryCPUStepping()
<BR>{
<BR><DD>	unsigned char _stepping;
<BR>
<BR><DD>	__asm{
<BR><DD><DD><DD>		mov     eax, 1  ; request for feature flags
<BR><DD><DD><DD>	   	_emit	0x0F    ; CPUID on Pentiums is 0f,a2
<BR><DD><DD><DD>	    _emit	0xA2
<BR>
<BR><DD><DD><DD>		and eax, 0x0F
<BR><DD><DD><DD>		mov _stepping, al
<BR><DD>	};
<BR>
<BR><DD>	return _stepping;
<BR>}
<BR>
<BR>unsigned char QueryCPUModel()
<BR>{
<BR><DD>	unsigned char _model;
<BR>
<BR><DD>	__asm{
<BR><DD><DD><DD>		mov     eax, 1  ; request for feature flags
<BR><DD><DD><DD>	   	_emit	0x0F    ; CPUID on Pentiums is 0f,a2
<BR><DD><DD><DD>	    _emit	0xA2
<BR>
<BR><DD><DD><DD>		shr eax, 4
<BR><DD><DD><DD>		and eax, 0x0F
<BR><DD><DD><DD>		mov _model, al
<BR><DD>	};
<BR>
<BR><DD>	return _model;
<BR>}
<BR>
<BR>unsigned char QueryCPUFamily()
<BR>{
<BR><DD>	unsigned char _family;
<BR>
<BR><DD>	__asm{
<BR><DD><DD><DD>		mov     eax, 1  ; request for feature flags
<BR><DD><DD><DD>	   	_emit	0x0F    ; CPUID on Pentiums is 0f,a2
<BR><DD><DD><DD>	    _emit	0xA2
<BR>
<BR><DD><DD><DD>		shr eax, 8
<BR><DD><DD><DD>		and eax, 0x0F
<BR><DD><DD><DD>		mov _family, al
<BR><DD>	};
<BR>
<BR><DD>	return _family;
<BR>}
<BR>
<BR>unsigned char QueryCPUType()
<BR>{
<BR><DD>	char _type;
<BR>
<BR><DD>	__asm{
<BR><DD><DD><DD>		mov     eax, 1  ; request for feature flags
<BR><DD><DD><DD>	   	_emit	0x0F    ; CPUID on Pentiums is 0f,a2
<BR><DD><DD><DD>	    _emit	0xA2
<BR>
<BR><DD><DD><DD>		shr eax, 12
<BR><DD><DD><DD>		and eax, 0x03
<BR><DD><DD><DD>		mov _type, al
<BR><DD>	};
<BR>
<BR><DD>	return _type;
<BR>}
<BR>
<BR>unsigned long QueryCPUCount()
<BR>{
<BR><DD>	SYSTEM_INFO info;
<BR><DD>	GetSystemInfo(&info);
<BR><DD>	return info.dwNumberOfProcessors;
<BR>}
<BR>
<BR>bool LookUpL2CacheSize(int infoFlag, unsigned long& cacheSize)
<BR>{
<BR><DD>	int cacheFlag = infoFlag;
<BR><DD>	cacheFlag &= 0xFF;
<BR>
<BR><DD>	while (infoFlag > 0)
<BR><DD>	{
<BR><DD><DD><DD>		switch (cacheFlag)
<BR><DD><DD><DD>		{
<BR><DD><DD><DD><DD>			case 0x80:
<BR><DD><DD><DD><DD>			case 0x40:
<BR><DD><DD><DD><DD><DD>				cacheSize = 0;
<BR><DD><DD><DD><DD>			return true;
<BR>
<BR><DD><DD><DD><DD>			case 0x81:
<BR><DD><DD><DD><DD>			case 0x41:
<BR><DD><DD><DD><DD><DD>				cacheSize = 128;
<BR><DD><DD><DD><DD>			return true;
<BR>
<BR><DD><DD><DD><DD>			case 0x82:
<BR><DD><DD><DD><DD>			case 0x42:
<BR><DD><DD><DD><DD><DD>				cacheSize = 256;
<BR><DD><DD><DD><DD>			return true;
<BR>
<BR><DD><DD><DD><DD>			case 0x83:
<BR><DD><DD><DD><DD>			case 0x43:
<BR><DD><DD><DD><DD><DD>				cacheSize = 512;
<BR><DD><DD><DD><DD>			return true;
<BR>		
<BR><DD><DD><DD><DD>			case 0x84:
<BR><DD><DD><DD><DD>			case 0x44:
<BR><DD><DD><DD><DD><DD>				cacheSize = 1024;
<BR><DD><DD><DD><DD>			return true;
<BR>
<BR><DD><DD><DD><DD>			case 0x85:
<BR><DD><DD><DD><DD>			case 0x45:
<BR><DD><DD><DD><DD><DD>				cacheSize = 2048;
<BR><DD><DD><DD><DD>			return true;
<BR><DD><DD><DD>		}
<BR><DD><DD><DD>		infoFlag = infoFlag >> 8;
<BR><DD><DD><DD>		cacheFlag = infoFlag & 0xFF;
<BR><DD>	}
<BR>
<BR><DD>	return false;
<BR>}
<BR>
<BR>
<BR>unsigned long QueryCacheSize()
<BR>{
<BR><DD>	char cacheRepeatCount=0;
<BR><DD>	int eaxCacheDescriptor=0;
<BR><DD>	int ebxCacheDescriptor=0;
<BR><DD>	int ecxCacheDescriptor=0;
<BR><DD>	int edxCacheDescriptor=0;
<BR><DD>	unsigned long cacheSize=0;
<BR>
<BR><DD>	__asm{
<BR><DD><DD><DD>		//Let's find out the amount of the cache. 
<BR><DD><DD><DD>		//That will help us later on figure out which processor we are running...
<BR><DD><DD><DD>		mov eax, 2
<BR><DD><DD><DD>		_emit 0x0f
<BR><DD><DD><DD>		_emit 0xa2
<BR>
<BR><DD><DD><DD>		mov cacheRepeatCount, al
<BR><DD><DD><DD>		cmp al, 1
<BR><DD><DD><DD>		je   DONE_CACHE_CHECK
<BR>
<BR><DD><DD><DD>		REPEAT_CACHE_DETECT:
<BR><DD><DD><DD>		mov eax, 2
<BR><DD><DD><DD>		_emit 0x0f
<BR><DD><DD><DD>		_emit 0xa2
<BR>
<BR><DD><DD><DD>		dec cacheRepeatCount
<BR><DD><DD><DD>		jnz REPEAT_CACHE_DETECT		
<BR>
<BR><DD><DD><DD>		DONE_CACHE_CHECK:
<BR><DD><DD><DD>		mov eaxCacheDescriptor, eax
<BR><DD><DD><DD>		mov ebxCacheDescriptor, ebx
<BR><DD><DD><DD>		mov ecxCacheDescriptor, ecx
<BR><DD><DD><DD>		mov edxCacheDescriptor, edx
<BR><DD>	};
<BR>
<BR><DD>	if (LookUpL2CacheSize(eaxCacheDescriptor,cacheSize))
<BR><DD><DD><DD>		return cacheSize;
<BR><DD>	if (LookUpL2CacheSize(ebxCacheDescriptor,cacheSize))
<BR><DD><DD><DD>		return cacheSize;
<BR><DD>	if (LookUpL2CacheSize(ecxCacheDescriptor,cacheSize))
<BR><DD><DD><DD>		return cacheSize;
<BR><DD>	if (LookUpL2CacheSize(edxCacheDescriptor,cacheSize))
<BR><DD><DD><DD>		return cacheSize;
<BR>
<BR><DD>	return 0;
<BR>}
<BR>
<BR>
<BR>bool QuerySerialNumber(char* string)
<BR>{
<BR><DD>	char serialString[32];
<BR><DD>	bool isValid=false;
<BR><DD>	unsigned long one=0;
<BR><DD>	unsigned long two=0;
<BR><DD>	unsigned long three=0;
<BR>
<BR><DD>	if (QueryCPUID())
<BR><DD>	{
<BR><DD><DD><DD>		__asm {
<BR><DD><DD><DD><DD>			mov		eax, 0
<BR><DD><DD><DD><DD>			_emit	0x0f
<BR><DD><DD><DD><DD>			_emit	0xa2
<BR><DD><DD><DD><DD>			cmp     eax, 3
<BR><DD><DD><DD><DD>			jl      DONE
<BR>			
<BR><DD><DD><DD><DD>			mov		eax, 1
<BR><DD><DD><DD><DD>			_emit 0x0f
<BR><DD><DD><DD><DD>			_emit 0xa2
<BR>
<BR><DD><DD><DD><DD>			and	edx, 0x20000
<BR><DD><DD><DD><DD>			jz		DONE
<BR>
<BR><DD><DD><DD><DD>			mov		one,	eax
<BR>
<BR><DD><DD><DD><DD>			mov eax, 3
<BR><DD><DD><DD><DD>			_emit 0x0f
<BR><DD><DD><DD><DD>			_emit 0xa2
<BR>
<BR><DD><DD><DD><DD>			mov		two,	edx
<BR><DD><DD><DD><DD>			mov		three,	ecx
<BR><DD><DD><DD><DD>			mov		isValid,	1
<BR><DD><DD><DD><DD>			DONE:
<BR><DD><DD><DD>		};
<BR><DD>	}
<BR>		
<BR><DD>	if (isValid)
<BR><DD>	{
<BR><DD><DD><DD>		wsprintf(serialString,"%04x-%04x-%04x-%04x-%04x-%04x",
<BR><DD><DD><DD><DD><DD><DD>								one		>> 16,	one &	0x0000FFFF,
<BR><DD><DD><DD><DD><DD><DD>								two		>> 16,	two  &	0x0000FFFF,
<BR><DD><DD><DD><DD><DD><DD>								three	>> 16,	three & 0x0000FFFF);
<BR><DD>	}
<BR><DD>	else
<BR><DD><DD><DD>		strcpy(serialString,"###DISABLED OR NOT PRESENT###");
<BR>
<BR>
<BR><DD>	strcpy(string,serialString);
<BR><DD>	return isValid;
<BR>}
<BR>
<BR>
<BR>//If type==0x10, then it's a dual processor system...
<BR>//Also, if it's a P2, you need to check the L2 cache size to see if
<BR>//it's a celeron or a real P2.  If it's zero, it's a Celery.
<BR>const int cCPULookupTableSize=28;
<BR>#define MakeFingerprint(a,b,c) &nbsp &nbsp &nbsp &nbsp &nbsp ((((unsigned long)a) << 24) | \
<BR><DD><DD><DD>(((unsigned long)b) << 16) | (((unsigned long)c) << 8) | ((unsigned long)0))
<BR>
<BR>struct CPUFingerprint
<BR>{
<BR><DD>	//Fingerprint is (family | model | type )
<BR><DD>	unsigned long fingerprint;
<BR><DD>	char vendorID[16];
<BR><DD>	char description[64];
<BR>};
<BR>
<BR>
<BR>CPUFingerprint cpuLookupTable[cCPULookupTableSize]=
<BR>{
<BR><DD>	//The first four entries in the table are reserved for special processors.
<BR><DD>	{ MakeFingerprint(0x00, 0x00, 0x00), "Unknown vendor", "Unknown processor"},
<BR><DD>	{ MakeFingerprint(0x00, 0x00, 0x00), "Unknown vendor", "Intel8086"},
<BR><DD>	{ MakeFingerprint(0x00, 0x00, 0x00), "Unknown vendor", "Intel80286"},
<BR><DD>	{ MakeFingerprint(0x00, 0x00, 0x00), "Unknown vendor", "Intel80386"},
<BR>
<BR><DD>	//These are the ones that support CPUID, so we start the "real"
<BR><DD>	//lookup here.  Currently, this is offset number 4 in the array.
<BR><DD>	{ MakeFingerprint(0x04, 0x00, 0x00), "Unknown vendor", "Intel486 DX"},
<BR><DD>	{ MakeFingerprint(0x04, 0x01, 0x00), "Unknown vendor", "Intel486 DX"},
<BR><DD>	{ MakeFingerprint(0x04, 0x02, 0x00), "Unknown vendor", "Intel486 SX"},
<BR><DD>	{ MakeFingerprint(0x04, 0x03, 0x00), "Unknown vendor", "Intel487 or DX2"},
<BR><DD>	{ MakeFingerprint(0x04, 0x04, 0x00), "Unknown vendor", "Intel486 SL"},
<BR><DD>	{ MakeFingerprint(0x04, 0x05, 0x00), "Unknown vendor", "IntelSX2"},
<BR><DD>	{ MakeFingerprint(0x04, 0x07, 0x00), "Unknown vendor", "Write-Back Enhanced IntelDX2"},
<BR><DD>	{ MakeFingerprint(0x04, 0x08, 0x00), "Unknown vendor", "IntelDX4"},
<BR><DD>	{ MakeFingerprint(0x04, 0x08, 0x00), "Unknown vendor", "IntelDX4 OverDrive"},
<BR><DD>	{ MakeFingerprint(0x05, 0x01, 0x00), "Unknown vendor", "Pentium (60,66)"},
<BR><DD>	{ MakeFingerprint(0x05, 0x02, 0x00), "Unknown vendor", "Pentium (75 - 200)"},
<BR><DD>	{ MakeFingerprint(0x05, 0x01, 0x00), "Unknown vendor", "Pentium Overdrive (60,66)"},
<BR><DD>	{ MakeFingerprint(0x05, 0x02, 0x00), "Unknown vendor", "Pentium Overdrive (75 - 133)"},
<BR><DD>	{ MakeFingerprint(0x05, 0x03, 0x00), "Unknown vendor", "Pentium Overdrive for Intel486"},
<BR><DD>	{ MakeFingerprint(0x05, 0x01, 0x00), "Unknown vendor", "Pentium Overdrive (60,66)"},
<BR><DD>	{ MakeFingerprint(0x05, 0x04, 0x00), "Unknown vendor", "Pentium with MMX (166,200)"},
<BR><DD>	{ MakeFingerprint(0x05, 0x04, 0x00), "Unknown vendor", "Pentium MMX Overdrive (75 - 133)"},
<BR><DD>	{ MakeFingerprint(0x06, 0x01, 0x00), "Unknown vendor", "PentiumPro"},
<BR><DD>	{ MakeFingerprint(0x06, 0x03, 0x00), "Unknown vendor", "PentiumII model 3"},
<BR><DD>	{ MakeFingerprint(0x06, 0x05, 0x00), "Unknown vendor", "PentiumII model 5 or Celeron"},
<BR><DD>	{ MakeFingerprint(0x06, 0x08, 0x00), "Unknown vendor", "PentiumII or Celeron"},
<BR><DD>	{ MakeFingerprint(0x0F, 0x00, 0x08), "Unknown vendor", "Pentium 4" },
<BR><DD>	{ MakeFingerprint(0x0F, 0x01, 0x08), "Unknown vendor", "Pentium 4" },
<BR><DD>	{ MakeFingerprint(0x0F, 0x02, 0x09), "Unknown vendor", "Pentium 4" }
<BR>};
<BR>
<BR>
<BR>
<BR>void GetCPUInfoString(char* string)
<BR>{
<BR><DD>	long tableEntry=0;
<BR>	
<BR><DD>	if (Is8086())
<BR><DD><DD><DD>		tableEntry=1;
<BR><DD>	else if (Is80286())
<BR><DD><DD><DD>		tableEntry=2;
<BR><DD>	else if (Is80386())
<BR><DD><DD><DD>		tableEntry=3;
<BR><DD>	else if (QueryCPUID())
<BR><DD>	{
<BR><DD><DD><DD>		unsigned char family=QueryCPUFamily();
<BR><DD><DD><DD>		unsigned char model=QueryCPUModel();
<BR><DD><DD><DD>		unsigned char type=QueryCPUType();
<BR><DD><DD><DD>		//unsigned char stepping=QueryCPUStepping();
<BR>
<BR><DD><DD><DD>		unsigned long fingerprint = MakeFingerprint(family, model, type);
<BR>		
<BR><DD><DD><DD>		//Start the lookup at four to skip the reserved entries...
<BR><DD><DD><DD>		for (int x=4; x &lt cCPULookupTableSize; x++)
<BR><DD><DD><DD>		{
<BR><DD><DD><DD><DD>			if (fingerprint == cpuLookupTable[x].fingerprint)
<BR><DD><DD><DD><DD><DD>				tableEntry=x;
<BR><DD><DD><DD>		}
<BR>
<BR><DD><DD><DD>		//Fill in the vendor string...
<BR><DD><DD><DD>		QueryVendorString(cpuLookupTable[tableEntry].vendorID);
<BR><DD>	}
<BR>
<BR><DD>	unsigned long cacheSize = QueryCacheSize();
<BR><DD>	bool hasMMX = QueryMMX();
<BR><DD>	unsigned long cpuCount=QueryCPUCount();
<BR>
<BR><DD>	char serialId[64];
<BR><DD>	QuerySerialNumber(serialId);
<BR><DD>	bool hyperThreading = QueryHyperThreading();
<BR>
<BR><DD>	wsprintf(string,"---------------------------------------------------------\n"
<BR><DD><DD><DD><DD>						"Primary cpu =	%s\n"
<BR><DD><DD><DD><DD>						"CPUs present:	%d\n"
<BR><DD><DD><DD><DD>						"Vendor string:	%s\n"
<BR><DD><DD><DD><DD>						"L2 cache size:	%d\n"
<BR><DD><DD><DD><DD>						"MMX capable:	%d\n"
<BR><DD><DD><DD><DD>						"Serial ID:		%s\n"
<BR><DD><DD><DD><DD>						"HyperThread:	%d\n"
<BR><DD><DD><DD><DD>						"---------------------------------------------------------\n",
<BR><DD><DD><DD><DD><DD>						cpuLookupTable[tableEntry].description,
<BR><DD><DD><DD><DD><DD>						cpuCount,
<BR><DD><DD><DD><DD><DD>						cpuLookupTable[tableEntry].vendorID,
<BR><DD><DD><DD><DD><DD>						cacheSize,
<BR><DD><DD><DD><DD><DD>						hasMMX,
<BR><DD><DD><DD><DD><DD>						serialId,
<BR><DD><DD><DD><DD><DD>						hyperThreading);
<BR>}
<BR>
</FONT>
</TD></TR></TABLE>
</TD></TR></TABLE>
		</TD>
	</TR>
</TABLE>
<BR>
<TABLE width=800>
	<TR>
		<TD width=120>
			&nbsp
		</TD>
		<TD>
			<MAP NAME="siteinfo">
				<AREA SHAPE="RECT" COORDS="525,6,545,23" HREF="http://www.redhat.com/">
				<AREA SHAPE="RECT" COORDS="546,6,575,23" HREF="http://www.apache.org/">
				<AREA SHAPE="RECT" COORDS="576,6,607,23" HREF="http://www.php.net/">
			</MAP>
			<IMG SRC="/images/footer.jpg" USEMAP="#siteinfo" border=0 width=619 height=26>
		</TD>
	</TR>
</TABLE>
</body>
</html>

