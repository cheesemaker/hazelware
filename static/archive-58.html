<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<head>
	<title>Hazelware</title>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<LINK REL="SHORTCUT ICON" HREF="logo.ico">
</head>



<body vlink='#3173EB' link='#3173EB' leftmargin=0 topmargin=0 marginwidth=0 marginheight=0>

<meta name="ICBM" content="45.30027, -122.9719" />
<meta name="keywords" content="Palm PalmOS WinCE PocketPC PDA Development Wireless" />
<meta name="description" content="Postings from a wireless PDA developer." />
<link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
<style type="text/css">
<!--
A		{text-decoration:none}
a		{text-decoration:none}
A:hover 	{ color: #000000;  }
a:hover 	{ color: #000000;  }
-->
</style>


<table border=0 valign=top width=780>
	<TR>
		<TD width=100 valign=top>
		</TD>

		<!-- Title graphic -->
		<TD width=620 valign=top>
			<center><IMG SRC="/images/title.jpg" border=0 width=319 height=69></center>
			<br>&nbsp &nbsp &nbsp 


				<b><small>Logged in as <I><A HREF='/login.html'>Guest</A></I> &nbsp Mon, Jun. 23rd, 1:03 PM.  &nbsp &nbsp &nbsp </small></b>
	
		</TD>
		<TD>
		</TD>
	</TR>
	<TR>

		<!-- Spacer for left border -->
		<TD>
		<!-- MyMap -->
		<a href="http://www.maploco.com/view.php?id=2376202"><img border=0 width=150 height=75 src="http://www.maploco.com/vmap/2376202.png" alt="Visitor Map"></a>
		</TD>

		<!-- Image map for browsing -->
		<TD width=620 valign=top>
			<TABLE width="100%" align=center valign=top>
				<TR>
					<TD width="100%">
						<MAP NAME="linkmap">
							<AREA SHAPE="RECT" COORDS= "10,27,90,52"  HREF="/">
							<AREA SHAPE="RECT" COORDS="100,27,207,52" HREF="/programs/">
							<AREA SHAPE="RECT" COORDS="220,27,328,52" HREF="/tutorials/">
							<AREA SHAPE="RECT" COORDS="338,27,428,52" HREF="/friends/">
							<AREA SHAPE="RECT" COORDS="442,27,509,52" HREF="/links/">
							<AREA SHAPE="RECT" COORDS="517,27,608,52" HREF="mailto:bosshogg@luggle.com">
						</MAP>
						<IMG src="/images/header.jpg" width=619 height=79 USEMAP="#linkmap" border=0>
					</TD>
				</TR>
			</TABLE>

		</TD>

		<TD>
		</TD>

		<TD>
		</TD>	
	</TR>
	
	<TR>
		<TD align=right valign=top>

		<TABLE border=0 cellspacing=0 cellpadding=0 width=150 align=center valign=top bordercolor='#000000'>
<TR><TD>
<TABLE border=1 cellspacing=0 cellpadding=5 width=100% align=center valign=top bordercolor='#000000'><TR><TD bgcolor='#B5D0FF'><B>Recent Entries:</B></TD></TR>
<TR><TD bgcolor='#ffffff' height=100%>
<small>
<TABLE valign=top align=left>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-101.html'><small>What I&#39;ve Been Up To</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-100.html'><small>Debugging Windows Mobile/WinCE Applications Without ActiveSync</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-99.html'><small>LinkedIn</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-98.html'><small>I&#39;m BACK!!!!!!</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-97.html'><small>Code Monkey</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-96.html'><small>Cool 3D Code Snippet From My Former Life</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-95.html'><small>YouTube: The Revival of the Internet Time Killer</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-94.html'><small>WhereMate Released</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-93.html'><small>Palmasaurus Released As Freeware</small></a></TD></TR>
<TR><TD valign=top>
<IMG SRC='/images/smallbullet.gif' width=7 height=13></TD><TD>
<a href='/archive-92.html'><small>VM-Plus Beta</small></a></TD></TR>
</TABLE>
</TD></TR>
<TR><TD align=center valign=center>
<A HREF='/rss.xml'><IMG SRC='/images/rss.gif' border=0 width=60 height=14></A>
</TD></TR>
</TABLE>
</TD></TR>
<TR><TD><SMALL><SMALL><BR></SMALL></SMALL></TD></TR><TR><TD><TABLE border=1 cellspacing=0 cellpadding=5 width=100% align=center valign=top bordercolor='#000000'><TR><TD bgcolor='#B5D0FF'><B>Archive:</B></TD></TR><TR><TD bgcolor='#ffffff'><A HREF='/archive-2008.5.html'>May - 2008</A><br><A HREF='/archive-2008.4.html'>April - 2008</A><br><A HREF='/archive-2008.3.html'>March - 2008</A><br><A HREF='/archive-2007.10.html'>October - 2007</A><br><A HREF='/archive-2007.8.html'>August - 2007</A><br><A HREF='/archive-2007.7.html'>July - 2007</A><br><A HREF='/archive-2007.6.html'>June - 2007</A><br><A HREF='/archive-2007.5.html'>May - 2007</A><br><A HREF='/archive-2007.4.html'>April - 2007</A><br><A HREF='/archive-2006.12.html'>December - 2006</A><br><A HREF='/archive-2006.11.html'>November - 2006</A><br><A HREF='/archive-2006.9.html'>September - 2006</A><br><A HREF='/archive-2006.8.html'>August - 2006</A><br><A HREF='/archive-2006.7.html'>July - 2006</A><br><A HREF='/archive-2006.3.html'>March - 2006</A><br><A HREF='/archive-2006.2.html'>February - 2006</A><br><A HREF='/archive-2006.1.html'>January - 2006</A><br><A HREF='/archive-2005.12.html'>December - 2005</A><br><A HREF='/archive-2005.11.html'>November - 2005</A><br><A HREF='/archive-2005.10.html'>October - 2005</A><br><A HREF='/archive-2005.9.html'>September - 2005</A><br><A HREF='/archive-2005.8.html'>August - 2005</A><br><A HREF='/archive-2005.7.html'>July - 2005</A><br><A HREF='/archive-2005.6.html'>June - 2005</A><br><A HREF='/archive-2005.5.html'>May - 2005</A><br><A HREF='/archive-2005.4.html'>April - 2005</A><br><A HREF='/archive-2005.2.html'>February - 2005</A><br><A HREF='/archive-2005.1.html'>January - 2005</A><br><A HREF='/archive-2004.12.html'>December - 2004</A><br><A HREF='/archive-2004.11.html'>November - 2004</A><br><A HREF='/archive-2004.10.html'>October - 2004</A><br><A HREF='/archive-2004.9.html'>September - 2004</A><br><A HREF='/archive-2004.8.html'>August - 2004</A><br><A HREF='/archive-2004.7.html'>July - 2004</A><br><A HREF='/archive-2004.6.html'>June - 2004</A><br><A HREF='/archive-2004.5.html'>May - 2004</A><br><A HREF='/archive-2004.4.html'>April - 2004</A><br><A HREF='/archive-2004.3.html'>March - 2004</A><br></TD></TR></TABLE></small>
</TD></TR></TABLE>

		</TD>
		<TD width=620 valign=top>


<style type="text/css">
<!--
A		{text-decoration:none}
a		{text-decoration:none}
A:hover 	{ color: #000000;  }
a:hover 	{ color: #000000;  }
-->
</style>

<TABLE border=0 cellspacing=0 cellpadding=5 width=580 align=center valign=top bordercolor='#ffffff'>
	<TR>
		<TD bgcolor='#ffffff'>
			<HR><CENTER><BIG><BIG><B><a href='/archive-58.html' border=0>The NVFS DBCache</a></B></BIG></BIG></CENTER>
		</TD>
	</TR>
	<TR>
		<TD bgcolor='#ffffff'>
			<FONT COLOR=#000000>
			 Well, I had hoped to write more on NVFS after I had a lot more to say, however, I have received several emails (including one from <A HREF="http://palmos.combee.net">Ben</A>) that have a common misunderstanding about the NVFS implementations on the Tungsten T5 and the Treo 650, and I figured it might be helpful to try and clear it up.
<BR>By far, the issue that is most misunderstood is the DBCache that the devices utilize, and how it is flushed once it is full.  Before going too quickly into it, I should layout a little backstory on the NVFS implementation (especially regarding what is known as the DBCache.)  
<BR>Let&#39;s start with the physical layout of the T5.  According to the docs, the memory footprint on the T5 looks like this:
<PRE>
RAM: 32MB total
16MB – OS image copied from flash at boot
10MB – storage heap cache
6MB – dynamic heap

FLASH: 256MB total
160MB – VFS flash drive
55MB – flash-based storage heap
41MB – compressed OS image, hidden storage space, 
       and blocks for remapping bad sectors
</PRE>
<BR>As you can see, there is a 10 MB storage heap cache.  According to the SDK, while an application is running, any active/open databases are allocated out of this 10 MB.  This allocation occurs in almost exactly the same way that it is allocated on pre-NVFS devices.  (This 10 MB is what is commonly referred to as the DBCache, and I will henceforth refer to it as such.)  
<BR>Also according to the SDK, there are certain times when that DBCache is "flushed" to the VFS Flash drive for permanent storage: 
<PRE>
    1. Application exit 
    2. Power cycle 
    3. Database closing 
    4. Explicity by the user with the DmSyncDatabase function
</PRE>
<BR>The next time that a database is opened, it is copied from the VFS drive to the DBCache for quicker usage.  To better understand NVFS, you have to understand that the VFS memory is what is known as NAND memory.  One of the implications of NAND memory is that it is quick to read, but slow to write.  , and if you do have to write to NAND, it&#39;s better to do it in big chunks.  (For a <I>really</I> good explanation of NAND RAM, see <A HREF="http://www.ddj.com/documents/s=9570/ddj0503p/0503p.html?temp=BuIQ9QIKGf">Ed Nisley&#39;s article in the March 2005 issue of Dr. Dobb&#39;s Journal</A>).  Because of this limitation, palmOne&#39;s NVFS implementation is optimized to minimize the number of writes that occur to the NAND memory.  
<BR>This of course, is where the DBCache comes into play: to minimize the number of writes to NAND.  To date, this information has been understood by all of the people that have written me about <A HREF="/archive-54.html">my previous T5 NVFS article</A>.  The part that has not been understood is the runtime usage of the DBCache.  As pointed out earlier, it is only 10 MB in size.  For normal things, that is a fairly acceptable size.  However, in <A HREF="/archive-54.html">my sample loop</A>, I was allocating approximately 40 MB worth of data.  If the OS only flushed the DBCache during those 4 stated conditions above, no program could ever allocate a DB at runtime that was more than 10 MB without having to either close the database or explicitly call DmSyncDatabase.  For a 256 MB device, that would be quite a crippling limitation!  Fortunately, there is one more condition when the devices flush the DBCache: when the DBCache itself becomes full.  It is slightly buried in a very short paragraph in the SDK, but the docs do mention that when the DBCache becomes full, the OS will "intelligently purge" it.  If you take <A HREF="/archive-54.html">the code from my earlier article</A> and run it on the T5, you can actually see this in action.  Once the allocations hit around 8 MB, the T5 starts crawling.  This slow, chunking slowdown is occuring as the OS flushes the DBCache, and it is paying a penalty for the slow write speed of the NAND RAM.  I can&#39;t say exactly what algoritm the T5 and the 650 use to do the purging, but I have determined that it takes a fairly minimalist approach.  As my loop keeps allocating,  the DBCache fills and begins flushing, and it seems to keep having to flush until it is finished.  Because of this, I suspect that it is only flushing enough memory for the requested allocation.  Perhaps it should flush more, perhaps not; it probably depends on what you are doing.  My biggest complaint is that there isn&#39;t any exposed functionality to perform this flushing from the application&#39;s perspective.  If you are trying to squeeze every last bit of performance out of your application and you&#39;re running on an NVFS device, you&#39;re at the mercy of the OS in those regards.  The only function that is given to you as a developer is DmSyncDatabase, but that just writes it to the VFS RAM; it doesn&#39;t empty <I>ANYTHING</I> out of the DBCache.  Ugh.  
<BR>That&#39;s about it for my explanation of the DBCache.  I hope that it helps <I>someone</I>.  It certainly cost me a lot of blood sweat and mostly tears to figure it out.  As always, please <A HREF="mailto:bosshogg@luggle.com">let me know</A> if you think I&#39;ve gotten anything wrong.  
<BR>
<BR>-Jon 
			</FONT>
		</TD>
	</TR>
	<TR>
		<TD bgcolor='#dddddd' align = center colspan=2>
		<i>Submitted by bosshogg on Thursday the 24th of February 2005, at 09:07 pm</i>
		</TD>
	</TR>
</TABLE>
<BR>
</TD>
<TD width=20>
&nbsp
</TD>
<TD valign=top align=right>
		</TD>
	</TR>
</TABLE>
<BR>
<TABLE width=800>
	<TR>
		<TD width=120>
			&nbsp
		</TD>
		<TD>
			<MAP NAME="siteinfo">
				<AREA SHAPE="RECT" COORDS="525,6,545,23" HREF="http://www.redhat.com/">
				<AREA SHAPE="RECT" COORDS="546,6,575,23" HREF="http://www.apache.org/">
				<AREA SHAPE="RECT" COORDS="576,6,607,23" HREF="http://www.php.net/">
			</MAP>
			<IMG SRC="/images/footer.jpg" USEMAP="#siteinfo" border=0 width=619 height=26>
		</TD>
	</TR>
</TABLE>
</body>
</html>


